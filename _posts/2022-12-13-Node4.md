---
title: "Node.js 기초(4)"
execrpt: "Log, BatchScheduler 설명"
toc: true
toc_sticky: true
categories:
  - Node
tags:
  - Node
last_modified_at: 2022-12-13
---

# 로그
프로그램의 상태를 관찰할 수 있도록 프로그램이 제공하는 정보로서 대부분 텍스트 파일 형태로 존재한다.

# npm 명령어
프로젝트가 의존하는 패키지(혹은 플러그인)들을 다운로드 받기 위해 사용하는 명령어  
로그를 관리하기 위한 winston 패키지의 설치를 위해 npm 명령어의 이해가 필요하다.  

1) **프로젝트 최초 시작시 npm 초기화**  

프로젝트 root 폴더 위치에서 명령 프롬프트를 열고 아래의 명령어 수행 후 몇가지 프로젝트 정보를 입력해야 한다.  
아래의 명령어의 결과로 프로젝트 폴더 안에 package.json 파일이 생성된다.  
```
npm init
or
yarn init
```
2) **필요한 패키지를 다운로드 받고자 할 떄**  

프로젝트 root 폴더 위치에서 명령 프롬프트를 열고 아래의 명령어를 수행.  
`--save`옵션을 지정하면 사용하는 패키지 정보가 package.json 파일에 기록된다.  
```
npm install --save 패키지이름
or
yarn add 패키지이름
```
3) **패키지를 삭제할 경우**  

프로젝트 root 폴더 위치에서 명령 프롬프트를 열고 아래의 명령어 수행.  
`--save`옵션을 지정하면 삭제되는 패키지 정보가 package.json 파일에서도 제거된다.  
```
npm uninstall --save 패키지이름
or
yarn remove 패키지이름
```
4) **프로젝트를 완성하여 결과물 배포시**  

node_modules 폴더 내의 패키지들을 함꼐 배포하거나 git에 업로드 할 경우 저작권에 위배됨.  
그러므로 패키지 파일들은 삭제 후 배포해야 한다.  
배포된 소스코드를 내렵다은 사람은 프로젝트root 폴더 위치에서 명령 프롬프트를 열고 아래의 명령어를 수행하면 package.json 파일에 기록된 모든 패키지들을 일괄 다운로드 받을 수 있다.  
```
npm install
or
yarn install
```

# winston

node.js에서 로그를 파일 형태로 기록할 수 있는 기능을 제공하는 패키지.  
1년 내내 무중단을 원칙으로하는 백엔드 시스템 특성상 상당히 많은 양의 로그가 생성되고, 모든 로그를 하나의 파일에 기록하게 되면 특정 파일의 용량이 매우 커지게 된다.  
이를 방지하기 위해서 대부분의 로그 패키지들은 날짜별로 파일 생성, 지정한 용량보다 내용이 커질 경우 파일 분할 등의 기능을 기본을 제공한다.  

```
$ npm install --save winston
$ npm install --save winston-daily-rotate-file
```
혹은
```
$ yarn add winston
$ yarn add winston-daily-rotate-file
```

# 로그 수준
프로그램이 겪는 어떤 상황에 대한 심각도  

## 로그 수준의 예시
숫자가 낮을 수록 상황이 심각하거나 중요도가 높음을 의미.  
시스템 설정상에서 기록으로 남길 로그 수준을 2라고 지정한 경우 3,4,5 수준의 로그는 기록되지 않는다.  
대부분 개발과정에서는 4혹은 5 로 지정하고 완성 후 실제 서비스로 전환되면서 0이나 1 로 변경한다.  

| 수준 | 이름    | 의미                                                                   |
| ---- | ------- | ---------------------------------------------------------------------- |
| 1    | error   | 시스템이 다운될 정도의 심각한 에러가 발생함                            |
| 2    | warn    | 에러가 발생한 것은 아니지만 비정상 동작을 감지했을 때를 의미(경고)     |
| 3    | info    | 프로그램이 동작하는 과정에서 발생하는 주요 정보들을 출력               |
| 4    | varbose | 개발자가 남기는 기록                                                   |
| 5    | debug   | 개발자가 프로그램의 흐름을 추적할 용도로 변수값들을 기록하기 위해 사용 |

# 환경설정
프로그램이 구동하는데 필요한 정보들을 별도의 파일에 명시해 놓고 그 파일의 내용을 읽어들여 변수화 하는 기법.

> ex) OpenAPI 연동을 위한 API Key, Database 접속 정보 등


주로 보안이 필요한 내용을 별도 파일에 작성한 후 프로젝트 root 이외의 경로에 별도로 보관하는 형태로 활용한다.  
Node.js는 환경 설정 값을 운영체제의 환경 변수에 저장하는 것을 권장하지만 환경변수 외에 별도의 파일로 작성하는 경우도 존재한다.  
1. json파일을 활용하여 프로그램이 import하는 경우
2. 별도의 설정파일을 프로그램 외부에 두는 경우

## dotenv 패키지
node.js로 하여금 시스템 환경변수나 외부 파일에 명시된 설정값들을 로드할 수 있게 하는 패키지  

**설치하기**
```
$ npm install --save dotenv
or
$ yarn add dotenv
```
**설정파일 작성 방법**  
일반 텍스트파일이며 파일이름, 확장자 등은 개발자가 자유롭게 설정한다.(일반적으로`.env`확장자를 사용함)  
같은 단일 내용으로 구성되며 문자열, 숫자들을 구분하지 않고 따옴표 없이 적용한다.  
모든 값은 문자열로만 식별된다.  
```
설정변수이름 = 값
설정변수이름 = 값
설정변수이름 = 값
```
**설정값 로드**  
```js
const dotenv = require('dotenv');
dotenv.config({path: 설정파일경로});
console.log(process.env.설정변수이름);
```

# 로그 예시
```js
/** (1) 패키지 참조 */
// 이전 시간에 했던 helper
const {mkdir} = require('../helper/FileHelper');
const winston = require('winston');
const winstonDaily = require('winston-daily-rotate-file');

/** (2) 환경설정 정보 */
const LOG_PATH = '_files/_logs';
const LOG_LEVEL = 'debug';

/** (3) 로그가 저장될 폴더 생성 */
mkdir(LOG_PATH);

/** (4) 로그가 출력될 형식 지정하기 위한 함수 추출 */
const {combine, timestamp, printf, splat, colorize} = winston.format;

/** (5) winstion 객체 만들기 */
const logger = winston.createLogger({
    // 로그의 전반적인 형식
    format: combine(
        timestamp({
            // 날짜 출력형식은 https://day.js.org/docs/en/display/format 참고
            // format : 'YYYY-MM-DD HH:mm:ss',
            format: "YY/MM/DD HH:mm:ss SSS",
        }),
        printf((info)=>{
            // 시간값, 로그수준, 출력할내용 순
            return `${info.timestamp} [${info.level}]: ${info.message}`;
        }),
        splay() // 로그하나 출력후 줄 바꿈.
    ),
    // 일반 로그 규칙 정의
    transports: [
        // 하루에 하나씩 파일 형태로 기록하기 위한 설정
        new winstonDaily({
            name: 'log',
            level: LOG_LEVEL, // 출력할 로그의 수준
            datePattern: 'YYMMDD', // 파일 이름에 표시될 날짜 형식
            dirname: LOG_PATH, // 파일이 저장될 위치
            filename: 'log_%DATE%.log', // 파일이름 형식
            maxsize: 50000000, // 50Mb
            maxFiles: 50,
            zippedArchive: true,
        }),
    ],
});
/** (6) 콘솔 설정 */
// 프로덕션 버전(=상용화 버전)이 아니라면? 
if(process.env.NODE_ENV !== "production"){
    logger.add(
        new winstion.transports.Console({
            prettyPring: true,
            showLevel: true,
            level: LOG_LEVEL,
            format: combine(
                colorize({ all: true }),
                printf((info) => {
                    return `${info.timestamp} [${info.level}]: ${info.message}`;
                })
            ),
        })
    );
}

logger.error(`error 메시지 입니다. (1수준)`);
logger.warn(`warn 메시지 입니다. (2수준)`);
logger.info(`info 메시지 입니다. (3수준)`);
logger.verbose(`verbose 메시지 입니다. (4수준)`);
logger.debug(`debug 메시지 입니다. (5수준)`);
```

![](https://user-images.githubusercontent.com/105098581/207256102-08efc0f9-3fb7-4ce5-b6eb-b4538d4f1e95.png)
![](https://user-images.githubusercontent.com/105098581/207255467-02fd275f-3c46-40c8-97a7-942b63f83689.png)









